0000                             ;Z80 code to set up LCD on shield and write a string
0000                IO_ADDR_PIO0:   EQU   80H   
0000                IO_ADDR_PIO0_AD:   EQU   IO_ADDR_PIO0+0   
0000                IO_ADDR_PIO0_BD:   EQU   IO_ADDR_PIO0+1   
0000                IO_ADDR_PIO0_AC:   EQU   IO_ADDR_PIO0+2   
0000                IO_ADDR_PIO0_BC:   EQU   IO_ADDR_PIO0+3   
0000                IO_ADDR_PIO1:   EQU   80H   
0000                IO_ADDR_PIO1_AD:   EQU   IO_ADDR_PIO1+0   
0000                IO_ADDR_PIO1_BD:   EQU   IO_ADDR_PIO1+1   
0000                IO_ADDR_PIO1_AC:   EQU   IO_ADDR_PIO1+2   
0000                IO_ADDR_PIO1_BC:   EQU   IO_ADDR_PIO1+3   
A000                          .ORG   0A000H   
A000                             ; 
A000   01           SHADOW_A:   DB   1   
A001   01           SHADOW_B:   DB   1   
A002                             ; 
0000                          .ORG   0   
0000   31 28 23               LD   SP,9000   
0003                             ; LCD DB4-7
0003   0E 82                  LD   C,IO_ADDR_PIO1_AC   
0005   16 80                  LD   D,IO_ADDR_PIO1_AD   
0007   26 0F                  LD   H,0FH   
0009   2E 00                  LD   L,00H   
000B   CD 2B 00               CALL   PIOINIT   
000E   0E 83                  LD   C,IO_ADDR_PIO1_BC   
0010   16 81                  LD   D,IO_ADDR_PIO1_BD   
0012   26 FC                  LD   H,0FCH   
0014   2E 00                  LD   L,00H   
0016   CD 2B 00               CALL   PIOINIT   
0019   3E 00                  LD   A,0   
001B   32 00 A0               LD   (SHADOW_A),A   
001E   3E 00                  LD   A,0   
0020   32 01 A0               LD   (SHADOW_B),A   
0023   CD 43 00               CALL   RS_HIGH   
0026   CD 4F 00               CALL   E_LOW   
0029   18 FE        LOOP:     JR   LOOP   
002B                             ; 
002B                             ;  Init PIO port
002B                             ;  C: PIO control address
002B                             ;  D: PIO data address
002B                             ;  L: Data to set up
002B                             ;  H: IO pattern
002B                             ; 
002B                PIOINIT:      
002B                             ; Mode 3
002B   3E CF                  LD   A,0CFH   
002D   ED 79                  OUT   (C),A   
002F                             ;  IO pattern
002F   7C                     LD   A,H   
0030   ED 79                  OUT   (C),A   
0032                             ; 
0032                             ; Write initial data
0032   7D                     LD   A,L   
0033   4A                     LD   C,D   
0034   ED 79                  OUT   (C),A   
0036   C9                     RET      
0037   0E 81        RS_LOW:   LD   C,IO_ADDR_PIO1_BD   
0039   2A 01 A0               LD   HL,(SHADOW_B)   
003C   7E                     LD   A,(HL)   
003D   CB 87                  RES   0,A   
003F   77                     LD   (HL),A   
0040   ED 79                  OUT   (C),A   
0042   C9                     RET      
0043   0E 81        RS_HIGH:   LD   C,IO_ADDR_PIO1_BD   
0045   2A 01 A0               LD   HL,(SHADOW_B)   
0048   7E                     LD   A,(HL)   
0049   CB C7                  SET   0,A   
004B   77                     LD   (HL),A   
004C   ED 79                  OUT   (C),A   
004E   C9                     RET      
004F   0E 81        E_LOW:    LD   C,IO_ADDR_PIO1_BD   
0051   2A 01 A0               LD   HL,(SHADOW_B)   
0054   7E                     LD   A,(HL)   
0055   CB 8F                  RES   1,A   
0057   77                     LD   (HL),A   
0058   ED 79                  OUT   (C),A   
005A   C9                     RET      
005B   0E 81        E_HIGH:   LD   C,IO_ADDR_PIO1_BD   
005D   2A 01 A0               LD   HL,(SHADOW_B)   
0060   7E                     LD   A,(HL)   
0061   CB CF                  SET   1,A   
0063   77                     LD   (HL),A   
0064   ED 79                  OUT   (C),A   
0066   C9                     RET      
0067                             ; 
0067                             ;  C: PIO data address
0067                             ;  D:Data required (8 bits)
0067   CD 37 00     SETDATA:   CALL   RS_LOW   
006A   CD 5B 00               CALL   E_HIGH   
006D   7A                     LD   A,D   
006E   CB 3F                  SRL   A   
0070   CB 3F                  SRL   A   
0072   CB 3F                  SRL   A   
0074   CB 3F                  SRL   A   
0076                             ; 
0076   ED 79                  OUT   (C),A   
0078   CD 4F 00               CALL   E_LOW   
007B   CD 5B 00               CALL   E_HIGH   
007E   7A                     LD   A,D   
007F   E6 0F                  AND   0FH   
0081   ED 79                  OUT   (C),A   
0083   CD 4F 00               CALL   E_LOW   
0086   CD 5B 00               CALL   E_HIGH   
0089   CD 4F 00               CALL   E_LOW   
008C   CD 5B 00               CALL   E_HIGH   
008F   CD 4F 00               CALL   E_LOW   
0092   CD 5B 00               CALL   E_HIGH   
0095   CD 43 00               CALL   RS_HIGH   
0098                             ; 
0098   C9                     RET      
0099                             ; 


IO_ADDR_PIO0:       0080 DEFINED AT LINE 2
                    > USED AT LINE 3
                    > USED AT LINE 4
                    > USED AT LINE 5
                    > USED AT LINE 6
IO_ADDR_PIO0_AD:    0080 DEFINED AT LINE 3
IO_ADDR_PIO0_BD:    0081 DEFINED AT LINE 4
IO_ADDR_PIO0_AC:    0082 DEFINED AT LINE 5
IO_ADDR_PIO0_BC:    0083 DEFINED AT LINE 6
IO_ADDR_PIO1:       0080 DEFINED AT LINE 8
                    > USED AT LINE 9
                    > USED AT LINE 10
                    > USED AT LINE 11
                    > USED AT LINE 12
IO_ADDR_PIO1_AD:    0080 DEFINED AT LINE 9
                    > USED AT LINE 25
IO_ADDR_PIO1_BD:    0081 DEFINED AT LINE 10
                    > USED AT LINE 31
                    > USED AT LINE 66
                    > USED AT LINE 74
                    > USED AT LINE 82
                    > USED AT LINE 90
IO_ADDR_PIO1_AC:    0082 DEFINED AT LINE 11
                    > USED AT LINE 24
IO_ADDR_PIO1_BC:    0083 DEFINED AT LINE 12
                    > USED AT LINE 30
SHADOW_A:           A000 DEFINED AT LINE 16
                    > USED AT LINE 37
SHADOW_B:           A001 DEFINED AT LINE 17
                    > USED AT LINE 39
                    > USED AT LINE 67
                    > USED AT LINE 75
                    > USED AT LINE 83
                    > USED AT LINE 91
LOOP:               0029 DEFINED AT LINE 44
                    > USED AT LINE 44
PIOINIT:            002B DEFINED AT LINE 52
                    > USED AT LINE 28
                    > USED AT LINE 34
RS_LOW:             0037 DEFINED AT LINE 66
                    > USED AT LINE 100
RS_HIGH:            0043 DEFINED AT LINE 74
                    > USED AT LINE 41
                    > USED AT LINE 121
E_LOW:              004F DEFINED AT LINE 82
                    > USED AT LINE 42
                    > USED AT LINE 109
                    > USED AT LINE 115
                    > USED AT LINE 117
                    > USED AT LINE 119
E_HIGH:             005B DEFINED AT LINE 90
                    > USED AT LINE 101
                    > USED AT LINE 111
                    > USED AT LINE 116
                    > USED AT LINE 118
                    > USED AT LINE 120
SETDATA:            0067 DEFINED AT LINE 100
